<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Picks</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#000">
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#111;color:#eee}
    header{background:#000;padding:.75rem 1rem;font-size:1.2rem;font-weight:600}
    .card{background:#1a1a1a;margin:.5rem;border-radius:6px;padding:.75rem}
    .stars{color:#ffb400}
    .small{font-size:.75rem;color:#aaa}
  </style>
</head>
<body>
<header>üèÄüèà AI Picks</header>
<div id="acc" class="card">Accuracy: ‚Äî</div>
<div id="board" class="card">Loading‚Ä¶</div>

<script>
/* ----------  CONFIG  ---------- */
const ODDS_API_KEY = '565aff52053bb3cae394b800971049a7';
const SPORTS       = ['americanfootball_nfl','basketball_nba'];
const TODAY        = new Date(Date.now() + new Date().getTimezoneOffset() * 60000).toISOString().slice(0,10);

/* ----------  MODEL (weights will be overwritten nightly)  ---------- */
const W = [0.44,-0.41,0.10,-0.10,-0.39,0.17,-0.23,0.21,0.32];
const b = -0.045;
const mean = [0,0,2.3,2.3,0,50,0,0,50];
const std  = [5,5,1,1,6,15,1,1,15];
function sigmoid(x){return 1/(1+Math.exp(-x));}
function predict(f){
  let s = b;
  for(let i=0;i<9;i++) s += W[i]*(f[i]-mean[i])/std[i];
  return sigmoid(s);
}

/* ----------  LOCAL-STORAGE LOGGER  ---------- */
function logPick(gameId, league, away, home, pick, spread, total, conf){
  const hist = JSON.parse(localStorage.getItem('aiHist')||'[]');
  hist.push({gameId, league, away, home, pick, spread, total, conf, result:null});
  localStorage.setItem('aiHist', JSON.stringify(hist));
}
function scorePick(gameId, result){
  const hist = JSON.parse(localStorage.getItem('aiHist')||'[]');
  const row  = hist.find(r=>r.gameId===gameId);
  if(row){ row.result = result; localStorage.setItem('aiHist', JSON.stringify(hist)); }
  showAcc();
}
function showAcc(){
  const hist = JSON.parse(localStorage.getItem('aiHist')||'[]');
  const graded = hist.filter(r=>r.result);
  const won    = graded.filter(r=>r.result==='W').length;
  const acc    = graded.length ? (won/graded.length*100).toFixed(1)+'%' : '‚Äî';
  document.getElementById('acc').innerHTML = `Accuracy: ${acc} (${graded.length} graded)`;
}

/* ----------  FETCH  ---------- */
async function fetchSport(sport){
  const raw = `https://api.the-odds-api.com/v4/sports/${sport}/odds` +
              `?apiKey=${ODDS_API_KEY}&regions=us&markets=spreads,totals&oddsFormat=american`;
  const url = `https://corsproxy.io/?` + encodeURIComponent(raw);
  const res = await fetch(url);
  if(!res.ok) throw new Error('Odds-API error '+res.status);
  const data = await res.json();
  return data.filter(g => g.commence_time.slice(0,10) === TODAY);
}

/* ----------  RENDER  ---------- */
async function render(){
  const board = document.getElementById('board');
  try {
    const [nfl,nba] = await Promise.allSettled(SPORTS.map(fetchSport));
    const games = [...(nfl.status==='fulfilled'?nfl.value:[]),
                   ...(nba.status==='fulfilled'?nba.value:[])];
    if(!games.length){ board.innerHTML='<div class="card">No games today.</div>'; return;}
    board.innerHTML='';
    games.forEach(g=>{
      const spread = g.bookmakers[0].markets[0].outcomes.find(o=>o.name===g.home_team).point;
      const total  = g.bookmakers[0].markets[1].outcomes[0].point;
      const f      = [0,0,2,2,spread,50,0,0,50];
      const prob   = predict(f);
      const pick   = prob>0.5 ? g.home_team : g.away_team;
      const conf   = Math.max(prob,1-prob);
      const stars  = '‚òÖ'.repeat(Math.round(conf*5))+'‚òÜ'.repeat(5-Math.round(conf*5));
      board.insertAdjacentHTML('beforeend',
       `<div class="card">
          <div>${g.away_team} @ ${g.home_team}</div>
          <div>PICK: ${pick} <span class="stars">${stars}</span></div>
          <div class="small">Spread ${spread} | Total ${total} | Conf ${(conf*100).toFixed(0)}%</div>
          <button onclick="scorePick('${g.id}','W')">‚úÖ Win</button>
          <button onclick="scorePick('${g.id}','L')">‚ùå Loss</button>
          <button onclick="scorePick('${g.id}','P')">‚ûñ Push</button>
        </div>`);
      logPick(g.id, g.sport_key, g.away_team, g.home_team, pick, spread, total, conf);
    });
    showAcc();
  } catch(e){
    board.innerHTML='<div class="card">Error: '+e.message+'</div>';
  }
}

window.addEventListener('DOMContentLoaded', ()=>{render(); showAcc();});
</script>
</body>
</html>
