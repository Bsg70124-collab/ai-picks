<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI Picks</title>
  <meta name="theme-color" content="#000">
  <style>
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#111;color:#eee}
    header{background:#000;padding:.75rem 1rem;font-size:1.2rem;font-weight:600}
    .card{background:#1a1a1a;margin:.5rem;border-radius:6px;padding:.75rem}
    .stars{color:#ffb400}
    .small{font-size:.75rem;color:#aaa}
    button{margin:.25rem;padding:.4rem .8rem;border:0;background:#333;color:#fff;border-radius:4px}
  </style>
</head>
<body>
<header>üèÄüèà AI Picks</header>
<div id="acc" class="card">Accuracy: ‚Äî</div>
<div id="board" class="card">Loading‚Ä¶</div>

<script>
const BDL_KEY  = '59f29e05-1e15-4a7b-a237-c17d5ae79b';   // BallDon‚ÄôtLie
const SPORTS   = ['americanfootball_nfl','basketball_nba'];
const TODAY    = new Date().toISOString().slice(0,10);   // YYYY-MM-DD

/* ----------  FETCH (BallDon‚ÄôtLie ‚Äì live lines)  ---------- */
async function fetchSport(sport){
  const league = sport==='basketball_nba' ? 'nba' : 'nfl';
  const url = `https://api.balldontlie.io/${league}/v1/odds?dates[]=${TODAY}&per_page=100`;
  const res  = await fetch(url, {headers:{'Authorization':BDL_KEY}});
  if(!res.ok) throw new Error('BDL odds error '+res.status);
  const data = await res.json();
  if(!data.data) return [];
  return data.data.map(o=>({
    id: o.id,
    sport_key: sport,
    commence_time: o.game.date,
    home_team: o.game.home_team.name,
    away_team: o.game.away_team.name,
    bookmakers: [{
      markets: [
        { outcomes: [{ name: o.game.home_team.name, point: o.spread_open }, { name: o.game.away_team.name,  point: -o.spread_open }] },
        { outcomes: [{ point: o.total_open }] }
      ]
    }]
  }));
}

/* ----------  SIMPLE MODEL (fixed for now)  ---------- */
function predict(spread){
  return spread < 0 ? 0.55 : 0.45;
}

/* ----------  RENDER  ---------- */
async function render(){
  const board = document.getElementById('board');
  try {
    const [nfl,nba] = await Promise.allSettled(SPORTS.map(fetchSport));
    const games = [...(nfl.status==='fulfilled'?nfl.value:[]),
                   ...(nba.status==='fulfilled'?nba.value:[])];
    if(!games.length){ board.innerHTML='<div class="card">No games today.</div>'; return;}
    board.innerHTML='';
    games.forEach(g=>{
      const spread = g.bookmakers[0].markets[0].outcomes.find(o=>o.name===g.home_team).point;
      const total  = g.bookmakers[0].markets[1].outcomes[0].point;
      const prob   = predict(spread);
      const pick   = prob>0.5 ? g.home_team : g.away_team;
      const conf   = Math.max(prob,1-prob);
      const stars  = '‚òÖ'.repeat(Math.round(conf*5))+'‚òÜ'.repeat(5-Math.round(conf*5));
      board.insertAdjacentHTML('beforeend',
       `<div class="card">
          <div>${g.away_team} @ ${g.home_team}</div>
          <div>PICK: ${pick} <span class="stars">${stars}</span></div>
          <div class="small">Spread ${spread} | Total ${total} | Conf ${(conf*100).toFixed(0)}%</div>
          <button onclick="score('${g.id}','W')">‚úÖ Win</button>
          <button onclick="score('${g.id}','L')">‚ùå Loss</button>
          <button onclick="score('${g.id}','P')">‚ûñ Push</button>
        </div>`);
      logPick(g.id, g.sport_key, g.away_team, g.home_team, pick, spread, total, conf);
    });
    showAcc();
  } catch(e){
    board.innerHTML='<div class="card">Error: '+e.message+'</div>';
  }
}

/* ----------  LOCAL-STORAGE LOGGER  ---------- */
function logPick(gameId, league, away, home, pick, spread, total, conf){
  const hist = JSON.parse(localStorage.getItem('aiHist')||'[]');
  hist.push({gameId, league, away, home, pick, spread, total, conf, result:null});
  localStorage.setItem('aiHist', JSON.stringify(hist));
}
function score(gameId, result){
  const hist = JSON.parse(localStorage.getItem('aiHist')||'[]');
  const row  = hist.find(r=>r.gameId===gameId);
  if(row){ row.result = result; localStorage.setItem('aiHist', JSON.stringify(hist)); }
  showAcc();
}
function showAcc(){
  const hist = JSON.parse(localStorage.getItem('aiHist')||'[]');
  const graded = hist.filter(r=>r.result);
  const won    = graded.filter(r=>r.result==='W').length;
  const acc    = graded.length ? (won/graded.length*100).toFixed(1)+'%' : '‚Äî';
  document.getElementById('acc').innerHTML = `Accuracy: ${acc} (${graded.length} graded)`;
}

window.addEventListener('DOMContentLoaded', ()=>{render(); showAcc();});
</script>
</body>
</html>
